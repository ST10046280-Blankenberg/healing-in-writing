@model HealingInWriting.Models.Admin.ReportsDashboardViewModel
@using HealingInWriting.Models.Shared

@{
    ViewData["Title"] = "Admin Reports";
}

<link rel="stylesheet" href="~/css/views/admin-reports.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/shared/search-bar.css" asp-append-version="true" />
<main>
    <div class="admin-reports">
        <!-- Search and Filter Bar -->
        @{
            var searchConfig = new AdminSearchBarConfig
            {
                Controller = "Reports",
                Action = "Index",
                SearchPlaceholder = "Search events or categories...",
                SearchInputName = "SearchText",
                Dropdowns = new List<AdminFilterDropdown>
                {
                    new()
                    {
                        Name = "StockStatus",
                        Label = "All Stock Levels",
                        Options = new List<AdminDropdownOption>
                        {
                            new() { Value = "critical", Text = "Critical (<50)", Selected = Model.Filters.StockStatus == "critical" },
                            new() { Value = "low", Text = "Low (50-99)", Selected = Model.Filters.StockStatus == "low" },
                            new() { Value = "good", Text = "Good (100+)", Selected = Model.Filters.StockStatus == "good" }
                        }
                    },
                    new()
                    {
                        Name = "SortBy",
                        Label = "Sort By",
                        Options = new List<AdminDropdownOption>
                        {
                            new() { Value = "attendance-desc", Text = "Attendance ↓", Selected = Model.Filters.SortBy == "attendance-desc" },
                            new() { Value = "attendance-asc", Text = "Attendance ↑", Selected = Model.Filters.SortBy == "attendance-asc" },
                            new() { Value = "stock-desc", Text = "Stock ↓", Selected = Model.Filters.SortBy == "stock-desc" },
                            new() { Value = "stock-asc", Text = "Stock ↑", Selected = Model.Filters.SortBy == "stock-asc" }
                        }
                    }
                }
            };
        }
        <partial name="_AdminSearchBar" model="(searchConfig, Model.Filters.SearchText ?? string.Empty)" />

        <!-- Event Attendance Chart -->
        @{
            // Find the maximum attendance count for scaling
            var maxAttendance = Model.EventAttendance.Any() ? Model.EventAttendance.Max(e => e.AttendanceCount) : 1;
        }

        <div class="admin-reports__card">
            <h3 class="admin-reports__card-title">Event Attendance</h3>
            <div class="admin-reports__chart">
                <div class="admin-reports__chart-labels">
                    @foreach (var item in Model.EventAttendance)
                    {
                        <span class="admin-reports__chart-label">@item.EventTitle</span>
                    }
                </div>
                <div class="admin-reports__chart-area">
                    <div class="admin-reports__chart-grid">
                        @for (int i = 0; i <= 4; i++)
                        {
                            <div class="admin-reports__chart-grid-line"></div>
                        }
                    </div>
                    <div class="admin-reports__chart-bars">
                        @foreach (var item in Model.EventAttendance)
                        {
                            // Calculate width as a percentage of the max attendance
                            var percent = maxAttendance > 0 ? (item.AttendanceCount * 100.0 / maxAttendance) : 0;
                            <div class="admin-reports__chart-bar"
                                 style="width:@percent%; min-width:2px;"
                                 data-value="@item.AttendanceCount"
                                 title="@item.EventTitle: @item.AttendanceCount attendees">
                            </div>
                        }
                    </div>
                    <div class="admin-reports__chart-x-axis">
                        @for (int i = 0; i <= 4; i++)
                        {
                            var labelValue = (int)Math.Round(i * (maxAttendance / 4.0));
                            <span class="admin-reports__chart-x-label">@labelValue</span>
                        }
                    </div>

                </div>
            </div>
        </div>

        <!-- Story Submissions Section -->
        @* <div class="admin-reports__card">
            <h3 class="admin-reports__submissions-header">Story Submissions</h3>
            <div class="admin-reports__stats-row">
                <div class="admin-reports__stat-card admin-reports__stat-card--pending">
                    <p class="admin-reports__stat-number admin-reports__stat-number--pending">@Model.StoryPendingCount</p>
                    <p class="admin-reports__stat-label">Pending</p>
                </div>
                <div class="admin-reports__stat-card admin-reports__stat-card--published">
                    <p class="admin-reports__stat-number admin-reports__stat-number--published">@Model.StoryPublishedCount</p>
                    <p class="admin-reports__stat-label">Published</p>
                </div>
                <div class="admin-reports__stat-card admin-reports__stat-card--drafts">
                    <p class="admin-reports__stat-number admin-reports__stat-number--drafts">@Model.StoryDraftCount</p>
                    <p class="admin-reports__stat-label">Drafts</p>
                </div>
            </div>
            <div class="admin-reports__table-wrapper admin-reports__table-wrapper--scrollable">
                <table class="admin-reports__table">
                    <thead class="admin-reports__table-head">
                        <tr>
                            <th class="admin-reports__table-header">Title</th>
                            <th class="admin-reports__table-header">Author</th>
                            <th class="admin-reports__table-header">Date</th>
                            <th class="admin-reports__table-header">Status</th>
                        </tr>
                    </thead>
                    <tbody class="admin-reports__table-body">
                        @foreach (var story in Model.RecentStories)
                        {
                            <tr class="admin-reports__table-row"
                                data-story-id="@story.StoryId"
                                data-status="@story.Status.ToString().ToLower()"
                                data-date="@story.CreatedAt.ToString("yyyy-MM-dd")">
                                <td class="admin-reports__table-cell admin-reports__table-cell--title">@story.Title</td>
                                <td class="admin-reports__table-cell">@story.AuthorName</td>
                                <td class="admin-reports__table-cell">@story.CreatedAt.ToString("MMM dd, yyyy")</td>
                                <td class="admin-reports__table-cell">
                                    <span class="admin-reports__status-badge admin-reports__status-badge--@story.Status.ToString().ToLower()">
                                        @story.Status
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div> *@

        <!-- Book Inventory Snapshot -->
        <div class="admin-reports__card">
            <h3 class="admin-reports__card-title">Book Inventory Snapshot</h3>
            <div class="admin-reports__table-wrapper admin-reports__table-wrapper--scrollable">
                <table class="admin-reports__inventory-table">
                    <thead>
                        <tr>
                            <th class="admin-reports__inventory-header">Category</th>
                            <th class="admin-reports__inventory-header">Current Stock</th>
                            <th class="admin-reports__inventory-header">Status</th>
                        </tr>
                    </thead>
                    <tbody class="admin-reports__inventory-body">
                        @foreach (var row in Model.BookInventoryByCategory)
                        {
                            var status = row.StockCount < 50 ? "critical"
                                : row.StockCount < 100 ? "low"
                                : "good";
                            <tr class="admin-reports__inventory-row"
                                data-category="@row.Category"
                                data-stock-count="@row.StockCount"
                                data-threshold-critical="50"
                                data-threshold-low="100">
                                <td class="admin-reports__inventory-cell">@row.Category</td>
                                <td class="admin-reports__inventory-cell">@row.StockCount</td>
                                <td class="admin-reports__inventory-cell">
                                    <span class="admin-reports__status-badge admin-reports__status-badge--@status">
                                        @status.First().ToString().ToUpper()@status.Substring(1)
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>
