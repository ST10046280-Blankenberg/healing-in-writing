@model HealingInWriting.Models.Admin.AdminManageStoriesViewModel
@using HealingInWriting.Models.Shared

@{
    ViewData["Title"] = "Manage Stories";
}

@section Styles {
    <link rel="stylesheet" href="~/css/shared/admin-header.css" asp-append-version="true"/>
    <link rel="stylesheet" href="~/css/shared/search-bar.css" asp-append-version="true"/>
    <link rel="stylesheet" href="~/css/views/manage-stories.css" asp-append-version="true"/>
}

<main class="manage-stories">
    <!-- Header Section -->
    <header class="admin-header">
        <div class="admin-header__content">
            <div class="admin-header__text">    
                <h1 class="admin-header__title">Manage Stories</h1>
                <p class="admin-header__subtitle">Review and manage community story submissions.</p>
            </div>
        </div>
    </header>

    <!-- Search & Filters -->
    @if (TempData["StoryStatusMessage"] is string statusMessage)
    {
        <div class="manage-stories__alert" role="status">@statusMessage</div>
    }

    @{
        var searchConfig = new AdminSearchBarConfig
        {
            Controller = "Stories",
            SearchPlaceholder = "Search stories...",
            SearchInputName = "searchTerm",
            Dropdowns = new List<AdminFilterDropdown>
            {
                new()
                {
                    Name = "dateRange",
                    Label = "Any Date",
                    Options = Model.DateOptions.Select(o => new AdminDropdownOption
                    {
                        Value = o.Value,
                        Text = o.Label,
                        Selected = o.Selected
                    }).ToList()
                },
                new()
                {
                    Name = "status",
                    Label = "Any Status",
                    Options = Model.StatusOptions.Select(o => new AdminDropdownOption
                    {
                        Value = o.Value,
                        Text = o.Label,
                        Selected = o.Selected
                    }).ToList()
                },
                new()
                {
                    Name = "tag",
                    Label = "Any Tag",
                    Options = Model.TagOptions.Select(o => new AdminDropdownOption
                    {
                        Value = o.Value,
                        Text = o.Label,
                        Selected = o.Selected
                    }).ToList()
                },
                new()
                {
                    Name = "sortOrder",
                    Label = "Sort By",
                    Options = Model.SortOptions.Select(o => new AdminDropdownOption
                    {
                        Value = o.Value,
                        Text = o.Label,
                        Selected = o.Selected
                    }).ToList()
                }
            },
            HiddenFields = new Dictionary<string, string>
            {
                { "page", "1" }
            }
        };
    }

    <partial name="_AdminSearchBar" model="(searchConfig, Model.Filters.SearchTerm)" />

    <!-- Status Summary -->
    <section class="manage-stories__metrics">
        <div class="manage-stories__metric">
            <span class="manage-stories__metric-label">Submitted</span>
            <span class="manage-stories__metric-value">@Model.PendingCount</span>
        </div>
        <div class="manage-stories__metric">
            <span class="manage-stories__metric-label">Published</span>
            <span class="manage-stories__metric-value">@Model.PublishedCount</span>
        </div>
        <div class="manage-stories__metric">
            <span class="manage-stories__metric-label">Draft</span>
            <span class="manage-stories__metric-value">@Model.DraftCount</span>
        </div>
        <div class="manage-stories__metric">
            <span class="manage-stories__metric-label">Rejected</span>
            <span class="manage-stories__metric-value">@Model.RejectedCount</span>
        </div>
    </section>

    <!-- Stories Table -->
    <p class="manage-stories__results">Showing @Model.Stories.Count of @Model.TotalStories story@((Model.TotalStories == 1) ? string.Empty : "ies")</p>
    <div class="manage-stories__table-container">
        <table class="manage-stories__table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Submitted Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Stories.Any())
                {
                    <tr>
                        <td colspan="5" class="manage-stories__empty">No stories available yet.</td>
                    </tr>
                }
                else
                {
                    foreach (var story in Model.Stories)
                    {
                        <tr>
                            <td>
                                <span class="manage-stories__story-title">@story.Title</span>
                            </td>
                            <td>
                                <span class="manage-stories__author">@story.AuthorName</span>
                            </td>
                            <td>
                                <span class="manage-stories__date">@story.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</span>
                            </td>
                            <td>
                                <span class="manage-stories__status-badge @story.StatusBadgeClass">@story.StatusText</span>
                            </td>
                            <td>
                                @{
                                    var returnUrl = Url.Action("Manage", "Stories", new
                                    {
                                        area = "Admin",
                                        searchTerm = Model.Filters.SearchTerm,
                                        status = Model.Filters.Status,
                                        dateRange = Model.Filters.DateRange,
                                        tag = Model.Filters.Tag,
                                        sortOrder = Model.Filters.SortOrder,
                                        page = Model.Filters.Page
                                    });
                                }
                                <a class="manage-stories__review-btn"
                                   asp-area=""
                                   asp-controller="Stories"
                                   asp-action="Details"
                                   asp-route-id="@story.StoryId"
                                   asp-route-returnUrl="@returnUrl">Review</a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (Model.TotalPages > 1)
    {
        <nav class="manage-stories__pagination" aria-label="Stories pagination">
            <a class="manage-stories__pagination-link @(Model.CurrentPage == 1 ? "is-disabled" : null)"
               href="@(Model.CurrentPage == 1 ? "#" : Url.Action("Manage", "Stories", new {
                   area = "Admin",
                   searchTerm = Model.Filters.SearchTerm,
                   status = Model.Filters.Status,
                   dateRange = Model.Filters.DateRange,
                   tag = Model.Filters.Tag,
                   sortOrder = Model.Filters.SortOrder,
                   page = Model.CurrentPage - 1
               }))"
               aria-disabled="@(Model.CurrentPage == 1 ? "true" : "false")">Previous</a>

            @for (var pageNumber = 1; pageNumber <= Model.TotalPages; pageNumber++)
            {
                <a class="manage-stories__pagination-link @(pageNumber == Model.CurrentPage ? "is-active" : null)"
                   href="@Url.Action("Manage", "Stories", new {
                       area = "Admin",
                       searchTerm = Model.Filters.SearchTerm,
                       status = Model.Filters.Status,
                       dateRange = Model.Filters.DateRange,
                       tag = Model.Filters.Tag,
                       sortOrder = Model.Filters.SortOrder,
                       page = pageNumber
                   })"
                   aria-current="@(pageNumber == Model.CurrentPage ? "page" : null)">@pageNumber</a>
            }

            <a class="manage-stories__pagination-link @(Model.CurrentPage == Model.TotalPages ? "is-disabled" : null)"
               href="@(Model.CurrentPage == Model.TotalPages ? "#" : Url.Action("Manage", "Stories", new {
                   area = "Admin",
                   searchTerm = Model.Filters.SearchTerm,
                   status = Model.Filters.Status,
                   dateRange = Model.Filters.DateRange,
                   tag = Model.Filters.Tag,
                   sortOrder = Model.Filters.SortOrder,
                   page = Model.CurrentPage + 1
               }))"
               aria-disabled="@(Model.CurrentPage == Model.TotalPages ? "true" : "false")">Next</a>
        </nav>
    }
</main>
