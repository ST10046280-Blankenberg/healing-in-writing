@*
========================================
BACKEND DATA REQUIREMENTS
========================================
This page allows admins to create new events or edit existing ones.

FORM DATA TO SAVE/RETRIEVE:
- Event ID (int) - If editing existing event (from route parameter)
- Title (string) - events.title
- Event Type/Category (string) - events.event_type (e.g., "Community Event", "Workshop")
- Event Tags (List<int>) - Many-to-many relationship with tags table
  * Junction table: event_tags (event_id, tag_id)
- Description (text) - events.description (rich text content)
- Address/Location (string) - events.address
- Event Date (DateTime/Date) - events.event_date (single date for the event)
- Start Time (TimeSpan/Time) - events.start_time (event start time)
- End Time (TimeSpan/Time) - events.end_time (event end time)
- Cover Image (file upload) - events.cover_image_url or file path

NOTE: Date and times are separate fields:
- Use ONE date picker for the event date
- Use TWO time pickers for start and end times
- Backend should combine date + start_time and date + end_time into DateTime if needed

DATABASE OPERATIONS:
CREATE EVENT:
1. INSERT INTO events (title, event_type, description, address, event_date, start_time, end_time, cover_image_url)
2. INSERT INTO event_tags (event_id, tag_id) for each selected tag

EDIT EVENT:
1. GET event WHERE id = @eventId
2. Populate form with existing data
3. UPDATE events SET ... WHERE id = @eventId
4. DELETE FROM event_tags WHERE event_id = @eventId (clear old tags)
5. INSERT INTO event_tags ... (add new tags)

IMAGE UPLOAD HANDLING:
- Accept file uploads via <input type="file">
- Recommended storage: wwwroot/uploads/events/{eventId}_{filename}
- Save file path in events.cover_image_url
- Validate: Max size 5MB, allowed types: jpg, jpeg, png
- Consider cloud storage for production (Azure Blob, AWS S3)

TAG MANAGEMENT:
- Provide list of available tags from tags table
- Save selected tag IDs to event_tags junction table
- Display existing tags when editing (load from event_tags WHERE event_id = @eventId)

FORM SUBMISSION:
- Create: POST /Admin/Events/Create
- Edit: POST /Admin/Events/Edit/{id}
========================================
*@

@model HealingInWriting.Models.Events.CreateEventViewModel

@{
    ViewData["Title"] = Model.Id == 0 ? "Create Event" : "Edit Event";
}

<link rel="stylesheet" href="~/css/views/manage-events.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/shared/tag-input.css" asp-append-version="true" />

<main class="event-details-page">
    <form asp-area="Admin" asp-controller="Events" asp-action="Details" method="post" enctype="multipart/form-data" class="event-details">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="Latitude" />
        <input type="hidden" asp-for="Longitude" />
        
        @if (!ViewData.ModelState.IsValid)
        {
            <div style="padding: 1rem; margin: 1rem 0; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 0.25rem; color: #721c24;">
                <strong>Validation Errors:</strong>
                <ul style="margin: 0.5rem 0;">
                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                    {
                        <li>@error.ErrorMessage</li>
                    }
                </ul>
            </div>
        }
        
        <div asp-validation-summary="All" class="text-danger"></div>

        <!-- Event Cover Image -->
        <div class="event-details__image-upload">
            <div class="event-details__image-placeholder" style="position: relative; min-height: 200px; background: #f3f4f6; border-radius: 8px; overflow: hidden;">
                @if (!string.IsNullOrEmpty(Model.CoverImageUrl))
                {
                    <img id="coverImagePreview" src="@Model.CoverImageUrl" alt="Event cover" style="width: 100%; height: 100%; object-fit: cover; display: block;" />
                    <label for="CoverImage" style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                        Change Image
                    </label>
                }
                else
                {
                    <label for="CoverImage" style="cursor: pointer; width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #6b7280;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 8px;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <span>Click to upload cover image</span>
                        <span style="font-size: 12px; margin-top: 4px; color: #9ca3af;">JPG, PNG, GIF, WEBP (Max 5MB)</span>
                    </label>
                }
                <input type="file" asp-for="CoverImage" accept="image/*" style="display: none;" onchange="previewImage(event)" />
            </div>
            <input type="hidden" asp-for="CoverImageUrl" />
        </div>

        <script>
            function previewImage(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const placeholder = document.querySelector('.event-details__image-placeholder');
                        placeholder.innerHTML = `
                            <img id="coverImagePreview" src="${e.target.result}" alt="Event cover preview" style="width: 100%; height: 100%; object-fit: cover; display: block;" />
                            <label for="CoverImage" style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                Change Image
                            </label>
                        `;
                        // Re-attach the input element
                        const input = event.target.cloneNode(true);
                        input.onchange = previewImage;
                        placeholder.appendChild(input);
                    };
                    reader.readAsDataURL(file);
                }
            }
        </script>

        <!-- Event Category Badge -->
        <div class="event-details__form-group">
            <label class="event-details__label">Event Type</label>
            <select asp-for="EventType" class="event-details__input">
                <option value="">Select Event Type</option>
                @foreach (var eventType in Enum.GetValues(typeof(HealingInWriting.Domain.Events.EventType)))
                {
                    <option value="@eventType">@eventType</option>
                }
            </select>
            <span asp-validation-for="EventType" class="text-danger"></span>
        </div>

        <!-- Event Status -->
        <div class="event-details__form-group">
            <label class="event-details__label">Event Status</label>
            <select asp-for="EventStatus" class="event-details__input">
                @foreach (var status in Enum.GetValues(typeof(HealingInWriting.Domain.Events.EventStatus)))
                {
                    <option value="@status">@status</option>
                }
            </select>
            <span asp-validation-for="EventStatus" class="text-danger"></span>
        </div>

        <!-- Event Tags -->
        <div class="event-details__form-group event-details__form-group--full-width">
            <label class="event-details__label">Event Tags</label>
            <input type="text" id="EventTagsInput" class="event-details__input" placeholder="Add tag and press Enter" />
            <div id="EventTagsDisplay" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
            <input type="hidden" id="Tags" name="Tags" asp-for="Tags" />
        </div>

        <!-- Event Title Input -->
        <div class="event-details__form-group">
            <h4 class="event-details__form-label">Event Title</h4>
            <input asp-for="Title" type="text" class="event-details__input" placeholder="Enter event title..." required/>
            <span asp-validation-for="Title" class="text-danger"></span>
        </div>

        <!-- Capacity Input -->
        <div class="event-details__form-group">
            <label class="event-details__label">Event Capacity</label>
            <input asp-for="Capacity" type="number" class="event-details__input" placeholder="Enter capacity..." min="1"/>
            <span asp-validation-for="Capacity" class="text-danger"></span>
        </div>

        <!-- Address Inputs -->
        <div class="event-details__form-group event-details__form-group--full-width">
            <label class="event-details__label">Street Address</label>
            <input asp-for="StreetAddress" type="text" class="event-details__input" placeholder="Enter street address..." required/>
            <span asp-validation-for="StreetAddress" class="text-danger"></span>
        </div>

        <div class="event-details__form-group">
            <label class="event-details__label">Suburb</label>
            <input asp-for="Suburb" type="text" class="event-details__input" placeholder="Enter suburb..." required/>
            <span asp-validation-for="Suburb" class="text-danger"></span>
        </div>

        <div class="event-details__form-group">
            <label class="event-details__label">City</label>
            <input asp-for="City" type="text" class="event-details__input" placeholder="Enter city..." required/>
            <span asp-validation-for="City" class="text-danger"></span>
        </div>

        <div class="event-details__form-group">
            <label class="event-details__label">Province</label>
            <input asp-for="Province" type="text" class="event-details__input" placeholder="Enter province..." required/>
            <span asp-validation-for="Province" class="text-danger"></span>
        </div>

        <div class="event-details__form-group">
            <label class="event-details__label">Postal Code</label>
            <input asp-for="PostalCode" type="text" class="event-details__input" placeholder="0000" maxlength="4" required/>
            <span asp-validation-for="PostalCode" class="text-danger"></span>
        </div>

        <!-- Event Date Input -->
        <div class="event-details__form-group">
            <label class="event-details__label">Event Date</label>
            <input asp-for="EventDate" type="date" class="event-details__input" placeholder="mm/dd/yyyy"/>
            <span asp-validation-for="EventDate" class="text-danger"></span>
        </div>

        <!-- Start & End Times -->
        <div class="event-details__form-group event-details__form-group--full-width">
            <label class="event-details__label">Start & End Times</label>
            <div class="event-details__times-container">
                <input asp-for="StartTime" type="time" class="event-details__input event-details__input--time" placeholder="Start Time"/>
                <span class="event-details__time-separator">to</span>
                <input asp-for="EndTime" type="time" class="event-details__input event-details__input--time" placeholder="End Time"/>
            </div>
            <span asp-validation-for="StartTime" class="text-danger"></span>
            <span asp-validation-for="EndTime" class="text-danger"></span>
        </div>

        <!-- Description Rich Text Editor -->
        <div class="event-details__description-section">
            <label class="event-details__description-label">Description</label>
            <div class="event-details__editor">
                <div class="event-details__editor-toolbar">
                    <button class="event-details__toolbar-btn" type="button" title="Bold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="10.5" height="14" viewBox="0 0 24 24" fill="none">
                            <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6zM6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button class="event-details__toolbar-btn" type="button" title="Italic">
                        <svg xmlns="http://www.w3.org/2000/svg" width="10.5" height="14" viewBox="0 0 24 24" fill="none">
                            <path d="M19 4h-9M14 20H5M15 4L9 20" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button class="event-details__toolbar-btn" type="button" title="List">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none">
                            <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <textarea asp-for="Description" class="event-details__editor-textarea" placeholder="Enter description here..." required></textarea>
            </div>
            <span asp-validation-for="Description" class="text-danger"></span>
        </div>

        <!-- Submit Button -->
        <div class="event-details__bottom-section">
            <button type="submit" class="event-details__submit-btn">@(Model.Id == 0 ? "Create Event" : "Update Event")</button>
        </div>

    </form>
</main>

<partial name="_ValidationScriptsPartial" />
<script src="~/js/shared/tag-manager.js" asp-append-version="true"></script>
<script src="~/js/add-event.js" asp-append-version="true"></script>
