@*
========================================
BACKEND DATA REQUIREMENTS
========================================
This page displays all events (upcoming and past) for admin management.

REQUIRED DATA PER EVENT:
- Event Title (string)
- Start DateTime (DateTime) - For display as "Dec 15, 2024 • 7:00 PM"
- End DateTime (DateTime) - Optional, for duration calculation
- Location/Address (string) - Full address or venue name
- RSVP Status (string/bool) - "RSVPs Open" or "RSVPs Closed"

DATABASE FIELDS NEEDED:
- events.id
- events.title
- events.start_time
- events.end_time (optional)
- events.address OR events.location_name
- events.rsvp_deadline (DateTime) - Compare with current time to determine RSVP status
  * OR events.rsvps_enabled (boolean) - Manual toggle

RSVP STATUS LOGIC:
- Display "RSVPs Open" if: DateTime.Now < events.rsvp_deadline
- Display "RSVPs Closed" if: DateTime.Now >= events.rsvp_deadline
- Alternative: Use boolean flag events.rsvps_enabled

BUTTON ACTIONS NEEDED:
- Edit: GET /Admin/Events/Edit/{id}
- Cancel: POST /Admin/Events/Cancel/{id}
- Export RSVPs: GET /Admin/Events/ExportRsvps/{id} (returns CSV/Excel file)

SEARCH/FILTER REQUIREMENTS:
- Filter by location (events.address LIKE @location)
- Filter by date range (events.start_time BETWEEN @startDate AND @endDate)
- Sort by newest/oldest (ORDER BY events.created_at DESC)
========================================
*@

@model HealingInWriting.Models.Events.AdminManageEventsViewModel

@{
    ViewData["Title"] = "Manage Events";
}

@section Styles {
    <link rel="stylesheet" href="~/css/shared/admin-header.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/shared/search-bar.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/views/manage-events.css" asp-append-version="true" />
}

<main class="admin-manage-events">
    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" style="padding: 1rem; margin: 1rem 0; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 0.25rem; color: #155724;">
            @TempData["SuccessMessage"]
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" style="padding: 1rem; margin: 1rem 0; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 0.25rem; color: #721c24;">
            @TempData["ErrorMessage"]
        </div>
    }

    <!-- Header Section -->
    <header class="admin-header">
        <div class="admin-header__content">
            <div class="admin-header__text">
                <h1 class="admin-header__title">Manage Events</h1>
                <p class="admin-header__subtitle">View, edit, and manage upcoming and past events</p>
            </div>
            <a href="@Url.Action("Details", "Events", new { area = "Admin"})" class="admin-header__action-btn">
                <svg class="admin-manage-events__create-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M12 5v14M5 12h14" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="admin-header__action-label">Create Event</span>
            </a>
            <form asp-area="Admin" asp-controller="Events" asp-action="SeedEvents" method="post" style="display:inline;">
                @Html.AntiForgeryToken()
                <button type="submit" class="admin-header__action-btn--secondary" style="margin-left: 1rem;">
                    <svg class="admin-manage-events__create-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M12 5v14M5 12h14" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="admin-header__action-label">Seed 10 Events</span>
                </button>
            </form>
        </div>
    </header>

    <!-- Search Bar -->
    <div class="search-bar">
        <div class="search-bar__input-container">
            <svg class="search-bar__icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="#9CA3AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <input type="text" class="search-bar__input" placeholder="Search..." />
        </div>

        <div class="search-bar__dropdown">
            <span class="search-bar__dropdown-label">Any Location</span>
            <svg class="search-bar__dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M6 9l6 6 6-6" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>

        <div class="search-bar__dropdown">
            <span class="search-bar__dropdown-label">Any Date</span>
            <svg class="search-bar__dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M6 9l6 6 6-6" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>

        <div class="search-bar__dropdown">
            <span class="search-bar__dropdown-label">Newest</span>
            <svg class="search-bar__dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M6 9l6 6 6-6" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>

        <button class="search-bar__button" type="button">
            <svg class="search-bar__button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="search-bar__button-label">Search</span>
        </button>
    </div>

    <!-- Events List Container -->
    <section class="admin-manage-events__events">
        <div class="admin-manage-events__events-header">
            <h2 class="admin-manage-events__events-title">Events</h2>
        </div>

        <div class="admin-manage-events__events-list">
            @if (!Model.Events.Any())
            {
                <article class="event-item event-item--empty">
                    <div class="event-item__content" style="justify-content: center; text-align: center; padding: 2rem;">
                        <h3 class="event-item__title">No events yet</h3>
                        <p class="event-item__meta-text">Create your first event to see it listed here.</p>
                    </div>
                </article>
            }
            else
            {
                foreach (var eventItem in Model.Events)
                {
                    // Status badge styling
                    var statusBadgeClass = eventItem.Status switch
                    {
                        HealingInWriting.Domain.Events.EventStatus.Draft => "event-item__status--draft",
                        HealingInWriting.Domain.Events.EventStatus.Published => "event-item__status--published",
                        HealingInWriting.Domain.Events.EventStatus.Cancelled => "event-item__status--cancelled",
                        HealingInWriting.Domain.Events.EventStatus.Completed => "event-item__status--completed",
                        HealingInWriting.Domain.Events.EventStatus.InProgress => "event-item__status--inprogress",
                        HealingInWriting.Domain.Events.EventStatus.RegistrationClosed => "event-item__status--regclosed",
                        _ => "event-item__status--default"
                    };

                    var badgeClass = eventItem.IsRsvpOpen ? "event-item__badge--open" : "event-item__badge--closed";
                    var badgeLabel = eventItem.IsRsvpOpen ? "RSVPs Open" : "RSVPs Closed";
                    var schedule = eventItem.StartDateTime.ToString("dd MMM yyyy • HH:mm");
                    var endTime = eventItem.EndDateTime > eventItem.StartDateTime
                        ? $" - {eventItem.EndDateTime:HH:mm}"
                        : string.Empty;
                    var location = string.IsNullOrWhiteSpace(eventItem.LocationSummary)
                        ? "Location to be confirmed"
                        : eventItem.LocationSummary;

                    <article class="event-item">
                        <div class="event-item__content">
                            <div class="event-item__info">
                                <div class="event-item__title-row">
                                    <h3 class="event-item__title">@eventItem.Title</h3>
                                    <span class="event-item__status @statusBadgeClass">@eventItem.Status</span>
                                </div>
                                <div class="event-item__meta">
                                    <div class="event-item__meta-item">
                                        <svg class="event-item__icon" xmlns="http://www.w3.org/2000/svg" width="12.25" height="14" viewBox="0 0 24 24" fill="none">
                                            <rect x="3" y="4" width="18" height="18" rx="2" stroke="#4B5563" stroke-width="2"/>
                                            <path d="M16 2v4M8 2v4M3 10h18" stroke="#4B5563" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        <span class="event-item__meta-text">@schedule@endTime</span>
                                    </div>
                                    <div class="event-item__meta-item">
                                        <svg class="event-item__icon" xmlns="http://www.w3.org/2000/svg" width="10.5" height="14" viewBox="0 0 24 24" fill="none">
                                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" stroke="#4B5563" stroke-width="2"/>
                                            <circle cx="12" cy="9" r="2.5" stroke="#4B5563" stroke-width="2"/>
                                        </svg>
                                        <span class="event-item__meta-text">@location</span>
                                    </div>
                                    <span class="event-item__badge @badgeClass">@badgeLabel</span>
                                </div>
                            </div>
                            <div class="event-item__actions">
                                <form asp-area="Admin" asp-controller="Events" asp-action="UpdateStatus" asp-route-id="@eventItem.Id" method="post" class="event-item__status-form">
                                    @Html.AntiForgeryToken()
                                    <select name="status" class="event-item__status-select">
                                        @foreach (var status in Enum.GetValues(typeof(HealingInWriting.Domain.Events.EventStatus)))
                                        {
                                            <option value="@status" selected="@(eventItem.Status == (HealingInWriting.Domain.Events.EventStatus)status)">@status</option>
                                        }
                                    </select>
                                    <button type="submit" class="event-item__status-submit">Update</button>
                                </form>
                                <a class="event-item__btn event-item__btn--registrations" asp-area="Admin" asp-controller="Events" asp-action="Registrations" asp-route-id="@eventItem.Id">Registrations</a>
                                <a class="event-item__btn event-item__btn--edit" asp-area="Admin" asp-controller="Events" asp-action="Details" asp-route-id="@eventItem.Id">Edit</a>
                                <form asp-area="Admin" asp-controller="Events" asp-action="Delete" asp-route-id="@eventItem.Id" method="post" class="event-item__status-form" onsubmit="return confirm('Are you sure you want to delete this event? This action cannot be undone.');">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="event-item__btn event-item__btn--delete">Delete</button>
                                </form>
                            </div>
                        </div>
                    </article>
                }
            }
        </div>
    </section>
</main>
