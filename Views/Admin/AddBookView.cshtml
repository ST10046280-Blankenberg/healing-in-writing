@{
    ViewData["Title"] = "Add Book";
}

@section Styles {
    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="~/css/views/books.css" />
}

<main class="books" style="padding-top:32px;">
    <section style="
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding: 24px 32px;
        gap: 32px;
        width: 100%;
        max-width: 1313px;
        min-height: 1088px;
        background: #fff;
        border-radius: 16px;
        margin: 0 auto;
        box-shadow: var(--shadow-soft-lg);
    ">
        <form method="post" enctype="multipart/form-data" style="width:100%;">
            <div style="
                display: flex;
                flex-direction: row;
                align-items: flex-start;
                gap: 32px;
                width: 100%;
                max-width: 1249px;
            ">
                <!-- Cover Image Upload -->
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 8px;
                    width: 336px;
                    min-width: 336px;
                ">
                    <label for="CoverImage" style="
                        font-family: 'Open Sans', sans-serif;
                        font-size: 18px;
                        color: #0C0C20;
                        margin-bottom: 8px;
                    ">Cover image</label>
                    <div style="
                        width: 336px;
                        height: 504px;
                        background: url('/images/Checker.png'), #F6FAF9;
                        border-radius: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-bottom: 8px;
                        border: 1px solid var(--brand-300);
                    ">
                        <img id="coverPreview" src="~/images/placeholder-book.svg" alt="Book cover preview" style="width:100%; height:100%; object-fit:cover; border-radius:16px;" />
                    </div>
                    <input type="file" id="CoverImage" name="CoverImage" accept="image/*" class="input" style="margin-bottom:8px;" />
                </div>
                <!-- Book Details -->
                <div style="
                    display: flex;
                    flex-direction: column;
                    gap: 24px;
                    flex: 1;
                    min-width: 400px;
                ">
                    <div style="display: flex; flex-direction: row; align-items: flex-end; gap: 32px;">
                        <div style="flex: 1;">
                            <label id="IsbnLabel" for="IsbnPrimary" style="font-family: 'Poppins'; font-weight: 500; font-size: 14px; color: #374151;">ISBN</label>                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <input type="text" id="IsbnPrimary" name="IsbnPrimary" class="input" placeholder="Enter ISBN 10 or 13" style="margin-top:8px;" />
                                <input type="hidden" id="IsbnSecondary" name="IsbnSecondary" />
                                <div id="IsbnSecondaryContainer" style="display:none; margin-top:8px;">
                                    <label id="IsbnSecondaryLabel" for="IsbnSecondary" style="font-family: 'Poppins'; font-weight: 500; font-size: 14px; color: #374151;">
                                        ISBN
                                    </label>
                                    <input type="text" id="IsbnSecondaryDisplay" class="input" readonly />
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" style="height:56px; min-width:192px; font-size:16px;">Import Details</button>
                    </div>
                    <div style="display: flex; gap: 16px;">
                        <div style="flex: 1;">
                            <label for="Title" style="font-family: 'Poppins'; font-weight: 500; font-size: 14px; color: #374151;">Title</label>
                            <input type="text" id="Title" name="Title" class="input" placeholder="Subtext" style="margin-top:8px;" />
                        </div>
                    </div>
                    <div style="display: flex; gap: 16px;">
                        <div style="flex: 1;">
                            <label for="Author" style="font-family: 'Poppins'; font-weight: 500; font-size: 14px; color: #374151;">Author</label>
                            <input type="text" id="Author" name="Author" class="input" placeholder="Subtext" style="margin-top:8px;" />
                        </div>
                        <div style="flex: 1;">
                            <label for="Language" style="font-family: 'Poppins'; font-weight: 500; font-size: 14px; color: #374151;">Language</label>
                            <input type="text" id="Language" name="Language" class="input" placeholder="Subtext" style="margin-top:8px;" />
                        </div>
                    </div>
                    <div style="display: flex; gap: 16px;">
                        <div style="flex: 1;">
                            <label for="PublishDate" style="font-family: 'Poppins'; font-weight: 500; font-size: 14px; color: #374151;">Publish Date</label>
                            <input type="text" id="PublishDate" name="PublishDate" class="input" placeholder="Subtext" style="margin-top:8px;" />
                        </div>
                        <div style="flex: 1;">
                            <label for="PageCount" style="font-family: 'Poppins'; font-weight: 500; font-size: 14px; color: #374151;">Page Count</label>
                            <input type="number" id="PageCount" name="PageCount" class="input" placeholder="Subtext" style="margin-top:8px;" />
                        </div>
                    </div>
                    <div>
                        <label for="Categories" style="font-family: 'Poppins'; font-weight: 500; font-size: 14px; color: #374151;">Categories</label>
                        <input type="text" id="CategoriesInput" class="input" placeholder="Add category and press Enter" style="margin-top:8px;" />
                        <div id="CategoryTags" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;"></div>
                        <input type="hidden" id="Categories" name="Categories" />
                    </div>
                    <div style="display: flex; gap: 16px; border-top:2px solid #2F1648; padding-top:8px;">
                        <div style="flex: 1;">
                            <label for="Condition" style="font-family: 'Poppins'; font-weight: 500; font-size: 14px; color: #374151;">Condition</label>
                            <select id="Condition" name="Condition" class="input" style="margin-top:8px;">
                                <option value="">Select condition</option>
                                <option value="New">New</option>
                                <option value="Like New">Like New</option>
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                                <option value="Poor">Poor</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label for="Price" style="font-family: 'Poppins'; font-weight: 500; font-size: 14px; color: #374151;">Price</label>
                            <input type="text" id="Price" name="Price" class="input" placeholder="Subtext" style="margin-top:8px;" />
                        </div>
                    </div>
                </div>
            </div>
            <!-- Description -->
            <div style="
                margin-top:32px;
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
                max-width: 1249px;
            ">
                <label for="Description" style="font-family: 'Poppins'; font-weight: 500; font-size: 14px; color: #374151;">Description</label>
                <textarea id="Description" name="Description" class="input" rows="10" placeholder="Enter description here..." style="
                    margin-top:8px;
                    width:100%;
                    min-height: 200px;
                    font-family: 'Poppins';
                    font-size: 16px;
                    color: #ADAEBC;
                    border-radius: 12px;
                    border: 1px solid #D1D5DB;
                    background: #fff;
                    resize:vertical;
                "></textarea>
            </div>
            <!-- Add Book Button -->
            <div style="margin-top:32px; display:flex; justify-content:flex-start;">
                <button type="submit" class="btn btn-primary" style="
                    min-width:192px;
                    height:56px;
                    font-family:'Poppins';
                    font-weight:500;
                    font-size:16px;
                    border-radius:8px;
                ">
                    Add Book
                </button>
            </div>
        </form>
    </section>
</main>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const isbnPrimary = document.getElementById('IsbnPrimary');
            const isbnLabel = document.getElementById('IsbnLabel');
            const isbnSecondary = document.getElementById('IsbnSecondary');
            const isbnSecondaryDisplay = document.getElementById('IsbnSecondaryDisplay');
            const isbnSecondaryLabel = document.getElementById('IsbnSecondaryLabel');
            const isbnSecondaryContainer = document.getElementById('IsbnSecondaryContainer');
            const importBtn = document.querySelector('button[type="button"].btn-primary');

            function updateIsbnLabel() {
                const val = isbnPrimary.value.trim();
                if(val.length === 0){
                    isbnLabel.textContent = 'ISBN:';
                } else if (val.length === 13) {
                    isbnLabel.textContent = 'ISBN: 13';
                } else if (val.length === 10) {
                    isbnLabel.textContent = 'ISBN: 10';
                } else {
                    isbnLabel.textContent = 'ISBN: Invalid';
                }
            }
            isbnPrimary.addEventListener('input', updateIsbnLabel);

            importBtn.addEventListener('click', async function () {
                const isbn = isbnPrimary.value.trim();
                if (!isbn) {
                    alert('Please enter an ISBN.');
                    return;
                }
                importBtn.disabled = true;
                importBtn.textContent = 'Importing...';
                try {
                    const response = await fetch(`/Books/ImportBookByIsbn?isbn=${encodeURIComponent(isbn)}`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        // ISBNs
                        const isbns = result.data.industryIdentifiers;
                        if (isbns.length > 0) {
                            isbnPrimary.value = isbns[0];
                            isbnLabel.textContent = isbns[0].length === 13 ? 'ISBN 13' : 'ISBN 10';
                        }
                        if (isbns.length > 1) {
                            isbnSecondary.value = isbns[1];
                            isbnSecondaryDisplay.value = isbns[1];
                            isbnSecondaryLabel.textContent = isbns[1].length === 13 ? 'ISBN 13' : 'ISBN 10';
                            isbnSecondaryContainer.style.display = 'block';
                        } else {
                            isbnSecondary.value = '';
                            isbnSecondaryDisplay.value = '';
                            isbnSecondaryContainer.style.display = 'none';
                        }
                        // Other fields...
                        document.getElementById('Title').value = result.data.title;
                        document.getElementById('Author').value = result.data.authors;
                        document.getElementById('Language').value = result.data.language;
                        document.getElementById('PublishDate').value = result.data.publishedDate;
                        document.getElementById('PageCount').value = result.data.pageCount;
                        categoryTagInput.setTags(result.data.categories || []);
                        document.getElementById('Description').value = result.data.description;
                        document.getElementById('coverPreview').src = result.data.thumbnailUrl || '/images/placeholder-book.svg';
                    } else {
                        alert(result.message || 'Book not found.');
                    }
                } catch (err) {
                    alert('Error importing book details: ' + err);
                    console.error('ImportBookByIsbn error:', err);
                } finally {
                    importBtn.disabled = false;
                    importBtn.textContent = 'Import Details';
                }
            });
        });
    </script>
    <script>
        let categoryTags = [];
        const categoryTagInput = {
            input: document.getElementById('CategoriesInput'),
            tagsDiv: document.getElementById('CategoryTags'),
            hidden: document.getElementById('Categories'),
            setTags: function(tags) {
                categoryTags = tags;
                this.render();
            },
            render: function() {
                this.tagsDiv.innerHTML = '';
                categoryTags.forEach((tag, idx) => {
                    const span = document.createElement('span');
                    span.className = 'book-card__tag';
                    span.innerHTML = `<span class="book-card__tag-text">${tag}</span> <button type="button" style="border:none;background:none;color:#c00;font-size:14px;cursor:pointer;" onclick="removeCategoryTag(${idx})">&times;</button>`;
                    this.tagsDiv.appendChild(span);
                });
                this.hidden.value = categoryTags.join(',');
            }
        };
        categoryTagInput.input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                e.preventDefault();
                categoryTags.push(this.value.trim());
                categoryTagInput.input.value = '';
                categoryTagInput.render();
            }
        });
        window.removeCategoryTag = function(idx) {
            categoryTags.splice(idx, 1);
            categoryTagInput.render();
        };
    </script>
}