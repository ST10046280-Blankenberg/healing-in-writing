@{
    ViewData["Title"] = "Add New Book";
}

<link rel="stylesheet" href="~/css/views/add-book.css" asp-append-version="true" />

<div class="add-book">
    <div class="add-book__container">
        <form class="add-book__form" method="post" asp-action="AddBook" enctype="multipart/form-data">

            <!-- Top Section: Cover Image + ISBN + Import Details -->
            <div class="add-book__top-section">
                <div class="add-book__left-column">
                    <!-- Cover Image Upload -->
                    <div class="add-book__form-group">
                        <label class="add-book__label">Cover image</label>
                        <div class="add-book__cover-upload" style="position:relative;">
                            <input type="file" id="coverImage" name="CoverImage" accept="image/*" class="add-book__file-input" />
                            <label for="coverImage" class="add-book__cover-placeholder" id="coverPlaceholder" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="1">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                            </label>
                            <img id="coverPreview" alt="Book cover preview"
                                 class="add-book__cover-preview"
                                 style="width:100%; height:100%; object-fit:cover; border-radius:8px; display:none; position:absolute; top:0; left:0; z-index:3;" />
                        </div>
                    </div>
                </div>

                <div class="add-book__right-column">
                    <!-- ISBN Field with Import Button -->
                    <div class="add-book__isbn-row">
                        <div class="add-book__form-group add-book__form-group--flex">
                            <div style="display: flex; flex-direction: row; gap: 16px; align-items: flex-start;">
                                <!-- Primary ISBN -->
                                <div class="add-book__isbn-field" style="display: flex; flex-direction: column; gap: 8px;">
                                    <label id="IsbnLabel" for="IsbnPrimary" class="add-book__label">ISBN</label>
                                    <input type="text" id="IsbnPrimary" name="IsbnPrimary" class="add-book__input" placeholder="Enter ISBN 10 or 13" />
                                </div>
                                <input type="hidden" id="IsbnSecondary" name="IsbnSecondary" />
                                <!-- Secondary ISBN (shown only when present) -->
                                <div id="IsbnSecondaryContainer" class="add-book__isbn-field" style="display:none; flex-direction: column; gap: 8px;">
                                    <label id="IsbnSecondaryLabel" for="IsbnSecondary" class="add-book__label">ISBN</label>
                                    <input type="text" id="IsbnSecondaryDisplay" class="add-book__input" readonly />
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-book__import-btn">Import Details</button>
                    </div>
                    <!-- Title Field -->
                    <div class="add-book__form-group">
                        <label for="Title" class="add-book__label">Title</label>
                        <input type="text" id="Title" name="Title" class="add-book__input" placeholder="Book Title" />
                    </div>
                    <!-- Author and Language Row -->
                    <div class="add-book__row">
                        <div class="add-book__form-group">
                            <label for="Author" class="add-book__label">Author</label>
                            <input type="text" id="Author" name="Author" class="add-book__input" placeholder="Subtext" required />
                        </div>
                        <div class="add-book__form-group">
                            <label for="Language" class="add-book__label">Language</label>
                            <input type="text" id="Language" name="Language" class="add-book__input" placeholder="Subtext" />
                        </div>
                    </div>

                    <!-- Publish Date and Page Count Row -->
                    <div class="add-book__row">
                        <div class="add-book__form-group">
                            <label for="PublishDate" class="add-book__label">Publish Date</label>
                            <input type="text" id="PublishDate" name="PublishDate" class="add-book__input" placeholder="Subtext" />
                        </div>
                        <div class="add-book__form-group">
                            <label for="PageCount" class="add-book__label">Page Count</label>
                            <input type="number" id="PageCount" name="PageCount" class="add-book__input" placeholder="Subtext" />
                        </div>
                    </div>

                    <!-- Category Field (Tag Input) -->
                    <div class="add-book__form-group">
                        <label for="Categories" class="add-book__label">Categories</label>
                        <input type="text" id="CategoriesInput" class="add-book__input" placeholder="Add category and press Enter" />
                        <div id="CategoryTags" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;"></div>
                        <input type="hidden" id="Categories" name="Categories" />
                    </div>

                    <!-- Middle Section: Condition and Price -->
                    <div class="add-book__middle-section">
                        <div class="add-book__row">
                            <div class="add-book__form-group">
                                <label for="Condition" class="add-book__label">Condition</label>
                                <input type="text" id="Condition" name="Condition" class="add-book__input" placeholder="Subtext" />
                            </div>
                            <div class="add-book__form-group">
                                <label for="Price" class="add-book__label">Price</label>
                                <input type="number" step="0.01" id="Price" name="Price" class="add-book__input" placeholder="Subtext" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rich Text Editor Section -->
            <div class="add-book__editor-section">
                <div class="add-book__editor">
                    <div class="add-book__editor-toolbar">
                        <!-- Toolbar buttons (not functional, just for style) -->
                        <button type="button" class="add-book__editor-btn" title="Bold">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button type="button" class="add-book__editor-btn" title="Italic">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                <line x1="19" y1="4" x2="10" y2="4" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <line x1="14" y1="20" x2="5" y2="20" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <line x1="15" y1="4" x2="9" y2="20" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button type="button" class="add-book__editor-btn" title="List">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none">
                                <line x1="8" y1="6" x2="21" y2="6" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <line x1="8" y1="12" x2="21" y2="12" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <line x1="8" y1="18" x2="21" y2="18" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <line x1="3" y1="6" x2="3.01" y2="6" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <line x1="3" y1="12" x2="3.01" y2="12" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <line x1="3" y1="18" x2="3.01" y2="18" stroke="#4B5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>
                    <textarea id="Description" name="Description" class="add-book__editor-textarea" placeholder="Enter description here..."></textarea>
                </div>
            </div>

            <!-- Bottom Section: Submit Button -->
            <div class="add-book__bottom-section">
                <button type="submit" class="add-book__submit-btn">Add Book</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ISBN logic
            const isbnPrimary = document.getElementById('IsbnPrimary');
            const isbnLabel = document.getElementById('IsbnLabel');
            const isbnSecondary = document.getElementById('IsbnSecondary');
            const isbnSecondaryDisplay = document.getElementById('IsbnSecondaryDisplay');
            const isbnSecondaryLabel = document.getElementById('IsbnSecondaryLabel');
            const isbnSecondaryContainer = document.getElementById('IsbnSecondaryContainer');
            const importBtn = document.querySelector('.add-book__import-btn');

            function updateIsbnLabel() {
                const val = isbnPrimary.value.trim();
                if(val.length === 0){
                    isbnLabel.textContent = 'ISBN:';
                } else if (val.length === 13) {
                    isbnLabel.textContent = 'ISBN: 13';
                } else if (val.length === 10) {
                    isbnLabel.textContent = 'ISBN: 10';
                } else {
                    isbnLabel.textContent = 'ISBN: Invalid';
                }
            }
            isbnPrimary.addEventListener('input', updateIsbnLabel);

            importBtn.addEventListener('click', async function () {
                const isbn = isbnPrimary.value.trim();
                if (!isbn) {
                    alert('Please enter an ISBN.');
                    return;
                }
                importBtn.disabled = true;
                importBtn.textContent = 'Importing...';
                try {
                    const response = await fetch(`/Books/ImportBookByIsbn?isbn=${encodeURIComponent(isbn)}`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        // ISBNs
                        const isbns = result.data.industryIdentifiers;
                        if (isbns.length > 0) {
                            isbnPrimary.value = isbns[0];
                            isbnLabel.textContent = isbns[0].length === 13 ? 'ISBN: 13' : 'ISBN: 10';
                        }
                        if (isbns.length > 1) {
                            isbnSecondary.value = isbns[1];
                            isbnSecondaryDisplay.value = isbns[1];
                            isbnSecondaryLabel.textContent = isbns[1].length === 13 ? 'ISBN: 13' : 'ISBN: 10';
                            isbnSecondaryContainer.style.display = 'flex';
                        } else {
                            isbnSecondary.value = '';
                            isbnSecondaryDisplay.value = '';
                            isbnSecondaryContainer.style.display = 'none';
                        }
                        document.getElementById('Title').value = result.data.title;
                        document.getElementById('Author').value = result.data.authors;
                        document.getElementById('Language').value = result.data.language;
                        document.getElementById('PublishDate').value = result.data.publishedDate;
                        document.getElementById('PageCount').value = result.data.pageCount;
                        categoryTagInput.setTags(result.data.categories || []);
                        document.getElementById('Description').value = result.data.description;
                        document.getElementById('coverPreview').src = result.data.thumbnailUrl || '/images/placeholder-book.svg';
                    } else {
                        alert(result.message || 'Book not found.');
                    }
                } catch (err) {
                    alert('Error importing book details: ' + err);
                    console.error('ImportBookByIsbn error:', err);
                } finally {
                    importBtn.disabled = false;
                    importBtn.textContent = 'Import Details';
                }
            });

            // Category tags logic
            let categoryTags = [];
            const categoryTagInput = {
                input: document.getElementById('CategoriesInput'),
                tagsDiv: document.getElementById('CategoryTags'),
                hidden: document.getElementById('Categories'),
                setTags: function(tags) {
                    categoryTags = tags;
                    this.render();
                },
                render: function() {
                    this.tagsDiv.innerHTML = '';
                    categoryTags.forEach((tag, idx) => {
                        const span = document.createElement('span');
                        span.className = 'book-card__tag';
                        span.innerHTML = `<span class="book-card__tag-text">${tag}</span> <button type="button" style="border:none;background:none;color:#c00;font-size:14px;cursor:pointer;" onclick="removeCategoryTag(${idx})">&times;</button>`;
                        this.tagsDiv.appendChild(span);
                    });
                    this.hidden.value = categoryTags.join(',');
                }
            };
            categoryTagInput.input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && this.value.trim()) {
                    e.preventDefault();
                    categoryTags.push(this.value.trim());
                    categoryTagInput.input.value = '';
                    categoryTagInput.render();
                }
            });
            window.removeCategoryTag = function(idx) {
                categoryTags.splice(idx, 1);
                categoryTagInput.render();
            };

            // Cover image logic
            const coverInput = document.getElementById('coverImage');
            const coverPreview = document.getElementById('coverPreview');
            const coverPlaceholder = document.getElementById('coverPlaceholder');

            coverInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (ev) {
                        coverPreview.src = ev.target.result;
                        coverPreview.style.display = 'block';
                        coverPlaceholder.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } else {
                    coverPreview.src = '';
                    coverPreview.style.display = 'none';
                    coverPlaceholder.style.display = 'block';
                }
            });

            // When importing from API, also hide the placeholder
            function setCoverImage(url) {
                if (url) {
                    coverPreview.src = url;
                    coverPreview.style.display = 'block';
                    coverPlaceholder.style.display = 'none';
                } else {
                    coverPreview.src = '';
                    coverPreview.style.display = 'none';
                    coverPlaceholder.style.display = 'block';
                }
            }

            // Update your import logic:
            importBtn.addEventListener('click', async function () {
                const isbn = isbnPrimary.value.trim();
                if (!isbn) {
                    alert('Please enter an ISBN.');
                    return;
                }
                importBtn.disabled = true;
                importBtn.textContent = 'Importing...';
                try {
                    const response = await fetch(`/Books/ImportBookByIsbn?isbn=${encodeURIComponent(isbn)}`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        // ISBNs
                        const isbns = result.data.industryIdentifiers;
                        if (isbns.length > 0) {
                            isbnPrimary.value = isbns[0];
                            isbnLabel.textContent = isbns[0].length === 13 ? 'ISBN: 13' : 'ISBN: 10';
                        }
                        if (isbns.length > 1) {
                            isbnSecondary.value = isbns[1];
                            isbnSecondaryDisplay.value = isbns[1];
                            isbnSecondaryLabel.textContent = isbns[1].length === 13 ? 'ISBN: 13' : 'ISBN: 10';
                            isbnSecondaryContainer.style.display = 'flex';
                        } else {
                            isbnSecondary.value = '';
                            isbnSecondaryDisplay.value = '';
                            isbnSecondaryContainer.style.display = 'none';
                        }
                        document.getElementById('Title').value = result.data.title;
                        document.getElementById('Author').value = result.data.authors;
                        document.getElementById('Language').value = result.data.language;
                        document.getElementById('PublishDate').value = result.data.publishedDate;
                        document.getElementById('PageCount').value = result.data.pageCount;
                        categoryTagInput.setTags(result.data.categories || []);
                        document.getElementById('Description').value = result.data.description;
                        setCoverImage(result.data.thumbnailUrl);
                    } else {
                        alert(result.message || 'Book not found.');
                    }
                } catch (err) {
                    alert('Error importing book details: ' + err);
                    console.error('ImportBookByIsbn error:', err);
                } finally {
                    importBtn.disabled = false;
                    importBtn.textContent = 'Import Details';
                }
            });
        });
    </script>
}